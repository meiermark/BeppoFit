services:
  db:
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_USER: beppo
      POSTGRES_PASSWORD: password
      POSTGRES_DB: beppofit
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data

  mailhog:
    image: mailhog/mailhog
    ports:
      - "1025:1025" # SMTP server
      - "8025:8025" # Web UI

  backend:
    build:
      context: ./beppo-fit-backend
      dockerfile: Dockerfile
    # Overwrite the command to run efficiently in dev mode if we were using a dev-specific logic
    # But for now we use the production-like build from Dockerfile
    # Ideally for dev we would use cargo watch, but let's stick to the base plan for now.
    environment:
      DATABASE_URL: postgres://beppo:password@db:5432/beppofit
      SMTP_HOST: mailhog
      SMTP_PORT: 1025
      JWT_SECRET: ${JWT_SECRET}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_REDIRECT_URL: ${GOOGLE_REDIRECT_URL}
      FRONTEND_URL: ${FRONTEND_URL}
    ports:
      - "8080:8080"
    depends_on:
      - db
      - mailhog
    restart: always

  app:
    build:
      context: ./beppo-fit-app
      dockerfile: Dockerfile
    ports:
      - "80:80"
    depends_on:
      - backend

volumes:
  db_data:
